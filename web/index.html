<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="/web.css">
  <script src="/jquery.js"></script>
  <script src="/survey.js"></script>
  <script src="/page.js"></script>
  <script src="/page_item.js"></script>
  <script src="/timelimit.js"></script>
  
  <script>
  var $directory = window.location.href.substring(0, window.location.href.lastIndexOf("/"));
  var $strings = null;
  
  $(document).ready(function(){
    $.ajax({
      url: $directory+"/strings.json"
    }).done(function(strings){
      $strings = strings;
      
      $.ajax({
        url: $directory+"/all_images.json"
      }).done(function(images){
        preload_images(images, function(){
          // images are loaded now
          // TODO
        });
      }).fail(function(error){
        alert("Verbindungsfehler");
      });
      
      loadSurvey("survey.json", function(s){ // TODO error handling
        window.survey = s;
        document.title = survey.title;
        $("#title").html(survey.title);
        survey.run();
      });
    });
  });
  
  // Show notification before the user closes
  window.onbeforeunload = function(){
    if (survey.finished){
      return null;
    } else {
      return _("If you proceed closing this page, your results won't be stored.");
    }
  }
  // returns a localizd version of string if possible or just str otherwise
  function _(str){
    if ($strings[str] != undefined) {
      return $strings[str];
    } else {
      return str;
    }
  }
  
  
  
  function preload_images(images, callback) {
    var remaining_images_to_load = images.length;
    var loading_objects = new Array;
    for (i=0; i<images.length; i++){
      image = new Image();
      image.onload = function() {
        remaining_images_to_load--;
        if (remaining_images_to_load <= 0) {
          callback();
        }
      }
      image.src = images[i];
      loading_objects.push(image);
    }
  }
  </script>
  
  <title>Survey</title>
</head>
<body>
  <h1 id="title">Survey</h1>
  <div id="time_left"></div>
  <div id="container"></div>
</body>
</html>